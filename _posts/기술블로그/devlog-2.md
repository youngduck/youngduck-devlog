---
title: "fs모듈로 만든 서버컴포넌트 Storybook에서 충돌하는 문제"
excerpt: "Nextjs Route Handler를 통해 문제상황 우회하기"
coverImage: "/assets/blog/posts/devlog/devlog-2/cover.png"
date: "2025-04-05T16:30:00"
ogImage:
  url: "/assets/blog/posts/devlog/devlog-2/cover.png"
---

## 문제상황

안녕하세요! YD-TECH 개발자 김영덕입니다.
오늘은 마크다운 형태로 저장된 게시물들을 가져오기 위해 FS모듈을 활용하여 리액트 서버 컴포넌트를 만들었는데요. 해당 컴포넌트를 스토리북으로 연결하는 도중 아래와 같은 에러가 발생했어요.
&nbsp;

![오류로그 : fs_WEBPACK_IMPORTED_MODULE_0___default(...).readdirSync](/assets/blog/posts/devlog/devlog-2/1.png)

### 문제상황 분석

하지만 이러한 오류가 어째서 발생했는지 궁금해졌습니다.
&nbsp;
스토리북은 NextJS에서 제공하는 리액트 서버 컴포넌트를 8.0 버전부터 실험적으로 지원해 주기 시작했는데요. 하지만 fs모듈 호출하는 오류가 어째서 발생하는지 [문서](https://storybook.js.org/blog/build-a-nextjs-app-with-rsc-msw-storybook/?ref=storybookblog.ghost.io)를 통해 자세히 알아 보았습니다.
&nbsp;
문서와 클로드에게서 알아낸 부분은 다음과 같았어요.

1. 스토리북은 브라우저에서 실행되지만, RSC 환경을 시뮬레이션하여 서버 컴포넌트가 포함된 스토리를 렌더링할 수 있게 합니다. 하지만 이 과정에서 모든 서버 API(예: fs 모듈)를 완벽하게 시뮬레이션할 수 없습니다.

2. 스토리북은 MSW와 같은 도구를 통해 네트워크 요청을 가로채고 모킹하는 방식으로 서버 기능을 시뮬레이션합니다. 이를 통해 서버 컴포넌트가 API를 호출하고 데이터를 가져오는 과정을 모킹할 수 있습니다.

즉 브라우저 환경에서 실행되는 스토리북의 특성상 Node.js 환경에서 실행되는 fs모듈을 시뮬레이션 할 수 없어서 생기는 오류였습니다.

&nbsp;

### 해결을 위한 고민

서버 컴포넌트에서 파일 시스템을 직접 접근하면서도 어떻게 하면 스토리북에서 테스트할 수 있을지 고민을 계속 하다가, NextJS의 Route Handler 기능이 떠올랐습니다. 이 기능을 활용하면 컴포넌트에서 직접 파일 시스템에 접근하는 대신, API를 통해 데이터를 가져올 수 있겠더라고요. 그러면 브라우저 환경인 스토리북에서도 API 호출을 모킹해서 컴포넌트를 테스트할 수 있을 것 같았습니다.

기존의 서버 렌더링 방식은 그대로 유지하면서, 스토리북에서는 fs모듈을 직접 호출하지 않도록 만들 수 있는 괜찮은 아이디어라 생각하여 시도해보았습니다.

### 문제해결하기

문제해결을 위해 다음과 같이 아키텍처를 변경했습니다.

1. 컴포넌트에서 파일시스템을 직접 호출하던 방식에서, Next.js의 Route Handler를 활용하여 데이터를 API로 가져오도록 변경.
2. 새로 만든 API를 스토리북에서 시뮬레이션 할 수 있게끔 MSW를 통해 해당 API에 목데이터 제공.

&nbsp;

### 결론

![스토리북에서 리액트 서버컴포넌트를 렌더링한 결과물](/assets/blog/posts/devlog/devlog-2/2.png)

이러한 아키텍처 변경 덕분에 기존의 서버 렌더링 방식은 그대로 유지하면서도, 스토리북에서 FS모듈을 사용하는 리액트 서버 컴포넌트를 효과적으로 테스트할 수 있게 되었습니다. 이제 파일 시스템에 접근하는 서버 컴포넌트도 스토리북에서 문제없이 시뮬레이션할 수 있게 되어 해당 컴포넌트들을 사용하던 페이지에서 스토리북 테스트가 가능해졌습니다.
